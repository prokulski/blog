<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Łukasz Prokulski" />

<meta name="date" content="2019-04-24" />

<title>Gole w europejskich ligach</title>

<script src="blog_post_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="blog_post_files/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="blog_post_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="blog_post_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="blog_post_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="blog_post_files/navigation-1.1/tabsets.js"></script>
<link href="blog_post_files/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="blog_post_files/highlightjs-9.12.0/highlight.js"></script>
<script src="blog_post_files/kePrint-0.0.1/kePrint.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Gole w europejskich ligach</h1>
<h4 class="author">Łukasz Prokulski</h4>
<h4 class="date">2019-04-24</h4>

</div>


<p>Skąd padają gole? Jak poruszają się piłkarze podczas meczu? Czy zawodnicy podają zawsze do tych samych?</p>
<p>Wszystkiego tego można się dowiedzieć jak tylko ma się odpowiednie dane… Warto przeglądać czasem Reddita - można znaleźć np. <a href="https://blog.prokulski.science/l.php?t=gole_w_ligach&amp;u=https://www.reddit.com/r/datasets/comments/bg1el1/soccer_shots_dataset/">Soccer shots dataset</a> (post już jest skasowany, ale kto pierwszy ten lepszy) zawierający link do <a href="https://blog.prokulski.science/l.php?t=gole_w_ligach&amp;u=https://drive.google.com/open?id=1yeIl0rZldsmmRzdGUkG56QmX7UXI0PHQ">arkusza z danymi</a> zeskrapowanymi z ciekawej strony <a href="https://blog.prokulski.science/l.php?t=gole_w_ligach&amp;u=https://understat.com/">understat.com</a>.</p>
<p>Skoro ktoś <em>zdjął</em> te dane i udało mi się zapisać do nich link to wykorzystajmy je!</p>
<p>W pierwszej kolejności musimy pobrać dane z Google Drive - lepiej mieć niż nie mieć ;)</p>
<pre class="r"><code># Będziemy potrzebowac standardowo pakietów:
library(tidyverse)
library(janitor)
library(igraph)

# a żeby pobrac dane z Google Drive wystarczy:
library(googledrive)

&quot;1yeIl0rZldsmmRzdGUkG56QmX7UXI0PHQ&quot; %&gt;%
  as_id() %&gt;%
  drive_get() %&gt;%
  drive_download(path = &quot;xg_master.csv&quot;)</code></pre>
<p>I w pliczku **“xg_master.csv** mamy interesujące nas dane. Zobaczmy co mamy w środku:</p>
<pre class="r"><code>data &lt;- read_csv(&quot;xg_master.csv&quot;) %&gt;%
  clean_names() %&gt;%
  mutate(player = stringi::stri_enc_tonative(player),
         assist_player = stringi::stri_enc_tonative(assist_player))</code></pre>
<p>Po standardowych <em>glimpse()</em> wiemy co i jak, na przykład wiemy że dane pochodzą z kilku sezonów i obejmują ligi europejskie z następującymi drużynami:</p>
<pre class="r"><code>data %&gt;%
  distinct(league, team) %&gt;%
  group_by(league) %&gt;%
  arrange(team) %&gt;%
  mutate(n = row_number()) %&gt;%
  ungroup() %&gt;%
  spread(league, team, fill = &quot;&quot;) %&gt;%
  select(-n) %&gt;%
  kable() %&gt;%
  kable_styling(bootstrap_options = c(&quot;striped&quot;, &quot;hover&quot;, &quot;condensed&quot;))</code></pre>
<table class="table table-striped table-hover table-condensed" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
Bundesliga
</th>
<th style="text-align:left;">
EPL
</th>
<th style="text-align:left;">
La_Liga
</th>
<th style="text-align:left;">
Ligue_1
</th>
<th style="text-align:left;">
RFPL
</th>
<th style="text-align:left;">
Serie_A
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Augsburg
</td>
<td style="text-align:left;">
Arsenal
</td>
<td style="text-align:left;">
Alaves
</td>
<td style="text-align:left;">
Amiens
</td>
<td style="text-align:left;">
Amkar
</td>
<td style="text-align:left;">
AC Milan
</td>
</tr>
<tr>
<td style="text-align:left;">
Bayer Leverkusen
</td>
<td style="text-align:left;">
Aston Villa
</td>
<td style="text-align:left;">
Almeria
</td>
<td style="text-align:left;">
Angers
</td>
<td style="text-align:left;">
Anzhi Makhachkala
</td>
<td style="text-align:left;">
Atalanta
</td>
</tr>
<tr>
<td style="text-align:left;">
Bayern Munich
</td>
<td style="text-align:left;">
Bournemouth
</td>
<td style="text-align:left;">
Athletic Club
</td>
<td style="text-align:left;">
Bordeaux
</td>
<td style="text-align:left;">
Arsenal Tula
</td>
<td style="text-align:left;">
Benevento
</td>
</tr>
<tr>
<td style="text-align:left;">
Borussia Dortmund
</td>
<td style="text-align:left;">
Brighton
</td>
<td style="text-align:left;">
Atletico Madrid
</td>
<td style="text-align:left;">
Caen
</td>
<td style="text-align:left;">
CSKA Moscow
</td>
<td style="text-align:left;">
Bologna
</td>
</tr>
<tr>
<td style="text-align:left;">
Borussia M.Gladbach
</td>
<td style="text-align:left;">
Burnley
</td>
<td style="text-align:left;">
Barcelona
</td>
<td style="text-align:left;">
Dijon
</td>
<td style="text-align:left;">
Dinamo Moscow
</td>
<td style="text-align:left;">
Cagliari
</td>
</tr>
<tr>
<td style="text-align:left;">
Darmstadt
</td>
<td style="text-align:left;">
Cardiff
</td>
<td style="text-align:left;">
Celta Vigo
</td>
<td style="text-align:left;">
Evian Thonon Gaillard
</td>
<td style="text-align:left;">
FC Krasnodar
</td>
<td style="text-align:left;">
Carpi
</td>
</tr>
<tr>
<td style="text-align:left;">
Eintracht Frankfurt
</td>
<td style="text-align:left;">
Chelsea
</td>
<td style="text-align:left;">
Cordoba
</td>
<td style="text-align:left;">
GFC Ajaccio
</td>
<td style="text-align:left;">
FC Orenburg
</td>
<td style="text-align:left;">
Cesena
</td>
</tr>
<tr>
<td style="text-align:left;">
FC Cologne
</td>
<td style="text-align:left;">
Crystal Palace
</td>
<td style="text-align:left;">
Deportivo La Coruna
</td>
<td style="text-align:left;">
Guingamp
</td>
<td style="text-align:left;">
FC Rostov
</td>
<td style="text-align:left;">
Chievo
</td>
</tr>
<tr>
<td style="text-align:left;">
Fortuna Duesseldorf
</td>
<td style="text-align:left;">
Everton
</td>
<td style="text-align:left;">
Eibar
</td>
<td style="text-align:left;">
Lens
</td>
<td style="text-align:left;">
FC Ufa
</td>
<td style="text-align:left;">
Crotone
</td>
</tr>
<tr>
<td style="text-align:left;">
Freiburg
</td>
<td style="text-align:left;">
Fulham
</td>
<td style="text-align:left;">
Elche
</td>
<td style="text-align:left;">
Lille
</td>
<td style="text-align:left;">
FC Yenisey Krasnoyarsk
</td>
<td style="text-align:left;">
Empoli
</td>
</tr>
<tr>
<td style="text-align:left;">
Hamburger SV
</td>
<td style="text-align:left;">
Huddersfield
</td>
<td style="text-align:left;">
Espanyol
</td>
<td style="text-align:left;">
Lorient
</td>
<td style="text-align:left;">
FK Akhmat
</td>
<td style="text-align:left;">
Fiorentina
</td>
</tr>
<tr>
<td style="text-align:left;">
Hannover 96
</td>
<td style="text-align:left;">
Hull
</td>
<td style="text-align:left;">
Getafe
</td>
<td style="text-align:left;">
Lyon
</td>
<td style="text-align:left;">
Krylya Sovetov Samara
</td>
<td style="text-align:left;">
Frosinone
</td>
</tr>
<tr>
<td style="text-align:left;">
Hertha Berlin
</td>
<td style="text-align:left;">
Leicester
</td>
<td style="text-align:left;">
Girona
</td>
<td style="text-align:left;">
Marseille
</td>
<td style="text-align:left;">
Kuban Krasnodar
</td>
<td style="text-align:left;">
Genoa
</td>
</tr>
<tr>
<td style="text-align:left;">
Hoffenheim
</td>
<td style="text-align:left;">
Liverpool
</td>
<td style="text-align:left;">
Granada
</td>
<td style="text-align:left;">
Metz
</td>
<td style="text-align:left;">
Lokomotiv Moscow
</td>
<td style="text-align:left;">
Inter
</td>
</tr>
<tr>
<td style="text-align:left;">
Ingolstadt
</td>
<td style="text-align:left;">
Manchester City
</td>
<td style="text-align:left;">
Las Palmas
</td>
<td style="text-align:left;">
Monaco
</td>
<td style="text-align:left;">
Mordovya
</td>
<td style="text-align:left;">
Juventus
</td>
</tr>
<tr>
<td style="text-align:left;">
Mainz 05
</td>
<td style="text-align:left;">
Manchester United
</td>
<td style="text-align:left;">
Leganes
</td>
<td style="text-align:left;">
Montpellier
</td>
<td style="text-align:left;">
Rubin Kazan
</td>
<td style="text-align:left;">
Lazio
</td>
</tr>
<tr>
<td style="text-align:left;">
Nuernberg
</td>
<td style="text-align:left;">
Middlesbrough
</td>
<td style="text-align:left;">
Levante
</td>
<td style="text-align:left;">
Nancy
</td>
<td style="text-align:left;">
SKA-Khabarovsk
</td>
<td style="text-align:left;">
Napoli
</td>
</tr>
<tr>
<td style="text-align:left;">
Paderborn
</td>
<td style="text-align:left;">
Newcastle United
</td>
<td style="text-align:left;">
Malaga
</td>
<td style="text-align:left;">
Nantes
</td>
<td style="text-align:left;">
Spartak Moscow
</td>
<td style="text-align:left;">
Palermo
</td>
</tr>
<tr>
<td style="text-align:left;">
RasenBallsport Leipzig
</td>
<td style="text-align:left;">
Norwich
</td>
<td style="text-align:left;">
Osasuna
</td>
<td style="text-align:left;">
Nice
</td>
<td style="text-align:left;">
Tom Tomsk
</td>
<td style="text-align:left;">
Parma
</td>
</tr>
<tr>
<td style="text-align:left;">
Schalke 04
</td>
<td style="text-align:left;">
Queens Park Rangers
</td>
<td style="text-align:left;">
Rayo Vallecano
</td>
<td style="text-align:left;">
Nimes
</td>
<td style="text-align:left;">
Torpedo Moscow
</td>
<td style="text-align:left;">
Parma Calcio 1913
</td>
</tr>
<tr>
<td style="text-align:left;">
VfB Stuttgart
</td>
<td style="text-align:left;">
Southampton
</td>
<td style="text-align:left;">
Real Betis
</td>
<td style="text-align:left;">
Paris Saint Germain
</td>
<td style="text-align:left;">
Tosno
</td>
<td style="text-align:left;">
Pescara
</td>
</tr>
<tr>
<td style="text-align:left;">
Werder Bremen
</td>
<td style="text-align:left;">
Stoke
</td>
<td style="text-align:left;">
Real Madrid
</td>
<td style="text-align:left;">
Reims
</td>
<td style="text-align:left;">
Ural
</td>
<td style="text-align:left;">
Roma
</td>
</tr>
<tr>
<td style="text-align:left;">
Wolfsburg
</td>
<td style="text-align:left;">
Sunderland
</td>
<td style="text-align:left;">
Real Sociedad
</td>
<td style="text-align:left;">
Rennes
</td>
<td style="text-align:left;">
Zenit St. Petersburg
</td>
<td style="text-align:left;">
Sampdoria
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
Swansea
</td>
<td style="text-align:left;">
Real Valladolid
</td>
<td style="text-align:left;">
Saint-Etienne
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
Sassuolo
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
Tottenham
</td>
<td style="text-align:left;">
SD Huesca
</td>
<td style="text-align:left;">
SC Bastia
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
SPAL 2013
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
Watford
</td>
<td style="text-align:left;">
Sevilla
</td>
<td style="text-align:left;">
Strasbourg
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
Torino
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
West Bromwich Albion
</td>
<td style="text-align:left;">
Sporting Gijon
</td>
<td style="text-align:left;">
Toulouse
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
Udinese
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
West Ham
</td>
<td style="text-align:left;">
Valencia
</td>
<td style="text-align:left;">
Troyes
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
Verona
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
Wolverhampton Wanderers
</td>
<td style="text-align:left;">
Villarreal
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
</tr>
</tbody>
</table>
<p>Jedna kolumna określa nam skuteczność strzału, a druga - sytuację. możemy więc zobaczyć…</p>
<pre class="r"><code># skąd co pada?
data %&gt;%
  ggplot() +
  geom_point(aes(x_coordinate, y_coordinate,
                 color = situation),
             alpha = 0.7, size = 0.5, show.legend = FALSE) +
  facet_grid(situation~result) +
  # boisko
  xlim(c(0, 1)) +
  ylim(c(0, 1)) +
  geom_rect(aes(xmin = 0, ymin = 0, xmax = 1, ymax = 1), fill = NA, color = &quot;black&quot;) +
  geom_rect(aes(xmin = 0, ymin = 0, xmax = 0.5, ymax = 1), fill = NA, color = &quot;black&quot;) +
  geom_rect(aes(xmin = 0, ymin = 0.2, xmax = 0.157, ymax = 0.8), fill = NA, color = &quot;black&quot;) +
  geom_rect(aes(xmin = 1, ymin = 0.2, xmax = 1-0.157, ymax = 0.8), fill = NA, color = &quot;black&quot;) +
  labs(title = &quot;Skąd padają strzały?&quot;, x = &quot;&quot;, y = &quot;&quot;) +
  theme_void() -&gt; plot

da_plot(plot, blank_x = T, blank_y = T)</code></pre>
<p><img src="blog_post_files/figure-html/gole_01-1.png" width="960" /></p>
<p>Prześledźmy na szybko rozkład informacji w kolumnach <em>kategorycznych</em>:</p>
<pre class="r"><code>data %&gt;% count(result, sort = TRUE) %&gt;%
  kable() %&gt;%
  kable_styling(bootstrap_options = c(&quot;striped&quot;, &quot;hover&quot;, &quot;condensed&quot;))</code></pre>
<table class="table table-striped table-hover table-condensed" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
result
</th>
<th style="text-align:right;">
n
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
MissedShots
</td>
<td style="text-align:right;">
99454
</td>
</tr>
<tr>
<td style="text-align:left;">
BlockedShot
</td>
<td style="text-align:right;">
61410
</td>
</tr>
<tr>
<td style="text-align:left;">
SavedShot
</td>
<td style="text-align:right;">
58449
</td>
</tr>
<tr>
<td style="text-align:left;">
Goal
</td>
<td style="text-align:right;">
25919
</td>
</tr>
<tr>
<td style="text-align:left;">
ShotOnPost
</td>
<td style="text-align:right;">
4797
</td>
</tr>
<tr>
<td style="text-align:left;">
OwnGoal
</td>
<td style="text-align:right;">
770
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>data %&gt;% filter(result == &quot;Goal&quot;) %&gt;% count(shot_type, sort = TRUE) %&gt;%
  kable() %&gt;%
  kable_styling(bootstrap_options = c(&quot;striped&quot;, &quot;hover&quot;, &quot;condensed&quot;))</code></pre>
<table class="table table-striped table-hover table-condensed" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
shot_type
</th>
<th style="text-align:right;">
n
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
RightFoot
</td>
<td style="text-align:right;">
13841
</td>
</tr>
<tr>
<td style="text-align:left;">
LeftFoot
</td>
<td style="text-align:right;">
7471
</td>
</tr>
<tr>
<td style="text-align:left;">
Head
</td>
<td style="text-align:right;">
4449
</td>
</tr>
<tr>
<td style="text-align:left;">
OtherBodyPart
</td>
<td style="text-align:right;">
158
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>data %&gt;% filter(result == &quot;Goal&quot;) %&gt;% count(situation, sort = TRUE) %&gt;%
  kable() %&gt;%
  kable_styling(bootstrap_options = c(&quot;striped&quot;, &quot;hover&quot;, &quot;condensed&quot;))</code></pre>
<table class="table table-striped table-hover table-condensed" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
situation
</th>
<th style="text-align:right;">
n
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
OpenPlay
</td>
<td style="text-align:right;">
18237
</td>
</tr>
<tr>
<td style="text-align:left;">
FromCorner
</td>
<td style="text-align:right;">
3057
</td>
</tr>
<tr>
<td style="text-align:left;">
Penalty
</td>
<td style="text-align:right;">
2233
</td>
</tr>
<tr>
<td style="text-align:left;">
SetPiece
</td>
<td style="text-align:right;">
1654
</td>
</tr>
<tr>
<td style="text-align:left;">
DirectFreekick
</td>
<td style="text-align:right;">
738
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>data %&gt;% filter(result == &quot;Goal&quot;) %&gt;% count(preceding_action, sort = TRUE) %&gt;%
  kable() %&gt;%
  kable_styling(bootstrap_options = c(&quot;striped&quot;, &quot;hover&quot;, &quot;condensed&quot;))</code></pre>
<table class="table table-striped table-hover table-condensed" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
preceding_action
</th>
<th style="text-align:right;">
n
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
7119
</td>
</tr>
<tr>
<td style="text-align:left;">
Cross
</td>
<td style="text-align:right;">
4594
</td>
</tr>
<tr>
<td style="text-align:left;">
Standard
</td>
<td style="text-align:right;">
2971
</td>
</tr>
<tr>
<td style="text-align:left;">
Rebound
</td>
<td style="text-align:right;">
2292
</td>
</tr>
<tr>
<td style="text-align:left;">
None
</td>
<td style="text-align:right;">
2232
</td>
</tr>
<tr>
<td style="text-align:left;">
Throughball
</td>
<td style="text-align:right;">
1447
</td>
</tr>
<tr>
<td style="text-align:left;">
TakeOn
</td>
<td style="text-align:right;">
1412
</td>
</tr>
<tr>
<td style="text-align:left;">
Chipped
</td>
<td style="text-align:right;">
1294
</td>
</tr>
<tr>
<td style="text-align:left;">
HeadPass
</td>
<td style="text-align:right;">
804
</td>
</tr>
<tr>
<td style="text-align:left;">
Aerial
</td>
<td style="text-align:right;">
767
</td>
</tr>
<tr>
<td style="text-align:left;">
BallRecovery
</td>
<td style="text-align:right;">
350
</td>
</tr>
<tr>
<td style="text-align:left;">
BallTouch
</td>
<td style="text-align:right;">
238
</td>
</tr>
<tr>
<td style="text-align:left;">
LayOff
</td>
<td style="text-align:right;">
153
</td>
</tr>
<tr>
<td style="text-align:left;">
Dispossessed
</td>
<td style="text-align:right;">
108
</td>
</tr>
<tr>
<td style="text-align:left;">
Tackle
</td>
<td style="text-align:right;">
47
</td>
</tr>
<tr>
<td style="text-align:left;">
Interception
</td>
<td style="text-align:right;">
23
</td>
</tr>
<tr>
<td style="text-align:left;">
BlockedPass
</td>
<td style="text-align:right;">
21
</td>
</tr>
<tr>
<td style="text-align:left;">
Foul
</td>
<td style="text-align:right;">
12
</td>
</tr>
<tr>
<td style="text-align:left;">
CornerAwarded
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:left;">
GoodSkill
</td>
<td style="text-align:right;">
6
</td>
</tr>
<tr>
<td style="text-align:left;">
Clearance
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
End
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
Goal
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
OffsidePass
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
SubstitutionOn
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
Card
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
Challenge
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
FormationChange
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
Start
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
<p>Ciekawe Tak sobie. Ciekawsze jest to, w której minucie padają gole. Zamiast liczyć jakąś średnią policzmy po prostu sumę bramek, które padły w kolejnych minutach:</p>
<pre class="r"><code>data %&gt;%
  filter(result == &quot;Goal&quot;) %&gt;%
  filter(minute &lt;= 92) %&gt;%
  count(minute) %&gt;%
  ggplot() +
  geom_line(aes(minute, n), color = &quot;green&quot;) +
  geom_smooth(aes(minute, n), color = &quot;lightgreen&quot;, alpha = 0.5) +
  geom_vline(xintercept = c(45, 90)) +
  labs(title = &quot;Liczba bramek w zależności od minuty meczu&quot;,
       x = &quot;Minuta meczu&quot;,
       y = &quot;Łączna liczba bramek&quot;) -&gt; plot

da_plot(plot)</code></pre>
<p><img src="blog_post_files/figure-html/gole_02-1.png" width="960" /></p>
<p>Dlaczego tuż po 45 minucie mamy skok? To <strong>gol do szatnii</strong> - nieco przedłużona pierwsza połowa i gol w ostatniej chwili.</p>
<p>Niesamowite jest to, że im dłużej trwa mecz tym więcej bramek pada, tzn. więcej bramek pada w <em>późniejszych</em> minutach. Wydawałoby się, że zmęczenie i - czasem - granie na czas dadzą zna oo sobie i więcej będzie goli w pierwszej połowie. A tutaj zonk. W sumie fajny zonk, bo oznacza to tyle że emocje są do końca.</p>
<p>Podzielmy czas na 5-minutowe bloki i sprawdźmy jak w poszczególnych ligach wygląda liczba zdobytych bramek. Tym razem jednak licząc jaki procent bramek z całej ligi wpada w danym bloku:</p>
<pre class="r"><code># bloki po 5 minut, zależność od ligi
data %&gt;%
  filter(result == &quot;Goal&quot;) %&gt;%
  mutate(minute = 5*( minute %/% 5) ) %&gt;%
  count(minute, league) %&gt;%
  group_by(league) %&gt;%
  mutate(n = 100*n/sum(n)) %&gt;%
  ungroup %&gt;%
  ggplot() +
  geom_tile(aes(minute, league, fill = n), color = &quot;gray50&quot;) +
  scale_fill_distiller(palette = &quot;Reds&quot;, direction = 1) +
  geom_vline(xintercept = c(45, 90)) +
  labs(title = &quot;Procent bramek w meczu zależności od minuty meczu&quot;,
       x = &quot;Minuta meczu&quot;,
       y = &quot;&quot;,
       fill = &quot;Procent bramek w lidze&quot;) -&gt; plot

da_plot(plot, legend_bottom = T)</code></pre>
<p><img src="blog_post_files/figure-html/gole_03-1.png" width="960" /></p>
<p>Znowu widać 45 minutę. Szczególnie w angielskiej Premiere League można liczy na emocje. W sumie około 6% (co 16 mecz) to bramka pod koniec I połowy.</p>
<p>Skupmy się na chwilę na konkretnych zawodnikach. Na przykład Neymar (ulubiony piłkarz mojego syna) - czy strzela w Paris Saint Germain lepiej niż w Barcelonie?</p>
<pre class="r"><code>data %&gt;%
  filter(player == &quot;Neymar&quot;) %&gt;%
  filter(result == &quot;Goal&quot;) %&gt;%
  count(date, team) %&gt;%
  ggplot() +
  geom_point(aes(date, n, color = team)) +
  labs(title = &quot;Neymar: Barcelona vs PSG&quot;,
       color = &quot;&quot;, x = &quot;&quot;, y = &quot;Liczba strzelonych\nbramek w meczu&quot;) -&gt; plot

da_plot(plot, legend_bottom = T)</code></pre>
<p><img src="blog_post_files/figure-html/gole_04-1.png" width="768" /></p>
<p>Strzela mniej więcej tak samo jeśli chodzi o liczbę zdobytych bramek w meczu. A czy strzela z innego miejsca? Może trener coś wypracował i zmieniło się ustawienie?</p>
<pre class="r"><code># skąd strzela
data %&gt;%
  filter(player == &quot;Neymar&quot;) %&gt;%
  filter(result == &quot;Goal&quot;) %&gt;%
  ggplot() +
  geom_point(aes(x_coordinate, y_coordinate, color = team)) +
  # boisko
  xlim(c(0, 1)) +
  ylim(c(0, 1)) +
  geom_rect(aes(xmin = 0, ymin = 0, xmax = 1, ymax = 1), fill = NA, color = &quot;black&quot;) +
  geom_rect(aes(xmin = 0, ymin = 0, xmax = 0.5, ymax = 1), fill = NA, color = &quot;black&quot;) +
  geom_rect(aes(xmin = 0, ymin = 0.2, xmax = 0.157, ymax = 0.8), fill = NA, color = &quot;black&quot;) +
  geom_rect(aes(xmin = 1, ymin = 0.2, xmax = 1-0.157, ymax = 0.8), fill = NA, color = &quot;black&quot;) +
  labs(title = &quot;Neymar: Barcelona vs PSG&quot;, x = &quot;&quot;, y = &quot;&quot;, color = &quot;&quot;) +
  theme_void() -&gt; plot

da_plot(plot, blank_x = T, blank_y = T, legend_bottom = T)</code></pre>
<p><img src="blog_post_files/figure-html/gole_05-1.png" width="960" /></p>
<p>To, że czerwonych kropek jest więcej oznacza tylko tyle, że dłużej grał w Barcy. Strzela mniej więcej z tego samego miejsca. No, w PSG ładuje trochę sprzed pola karnego.</p>
<p>Zobaczmy jak inni. Na początek przygotujemy fragment danych - 12 piłkarzy, którzy strzelili najwięcej bramek:</p>
<pre class="r"><code>top_strikers &lt;- data %&gt;%
  filter(result == &quot;Goal&quot;) %&gt;%
  count(player, sort = T) %&gt;%
  top_n(12, n) %&gt;%
  pull(player)</code></pre>
<pre class="r"><code>cat(&quot;&lt;ul&gt;\n&lt;li&gt;&quot;)</code></pre>
<ul>
<li>
<pre class="r"><code>cat(paste0(top_strikers, collapse = &quot;&lt;/li&gt;\n&lt;li&gt;&quot;))</code></pre>
Lionel Messi
</li>
<li>
Cristiano Ronaldo
</li>
<li>
Luis Su�rez
</li>
<li>
Robert Lewandowski
</li>
<li>
Harry Kane
</li>
<li>
Edinson Cavani
</li>
<li>
Pierre-Emerick Aubameyang
</li>
<li>
Sergio Ag�ero
</li>
<li>
Alexandre Lacazette
</li>
<li>
Gonzalo Higua�n
</li>
<li>
Mauro Icardi
</li>
<li>
<p>Antoine Griezmann</p>
<pre class="r"><code>cat(&quot;&lt;/li&gt;\n&lt;/ul&gt;\n&quot;)</code></pre>
</li>
</ul>
<p>Skąd strzelają bramki ci panowie?</p>
<pre class="r"><code>data %&gt;%
  filter(player %in% top_strikers) %&gt;%
  filter(result == &quot;Goal&quot;) %&gt;%
  ggplot() +
  geom_point(aes(x_coordinate, y_coordinate, color = player),
             show.legend = FALSE) +
  facet_wrap(~player) +
  # boisko
  xlim(c(0, 1)) +
  ylim(c(0, 1)) +
  geom_rect(aes(xmin = 0, ymin = 0, xmax = 1, ymax = 1), fill = NA, color = &quot;black&quot;) +
  geom_rect(aes(xmin = 0, ymin = 0, xmax = 0.5, ymax = 1), fill = NA, color = &quot;black&quot;) +
  geom_rect(aes(xmin = 0, ymin = 0.2, xmax = 0.157, ymax = 0.8), fill = NA, color = &quot;black&quot;) +
  geom_rect(aes(xmin = 1, ymin = 0.2, xmax = 1-0.157, ymax = 0.8), fill = NA, color = &quot;black&quot;) +
  labs(title = &quot;Skąd padają bramki strzelone przez...&quot;, x = &quot;&quot;, y = &quot;&quot;) +
  theme_void() -&gt; plot

da_plot(plot, blank_x = T, blank_y = T)</code></pre>
<p><img src="blog_post_files/figure-html/gole_06-1.png" width="960" /></p>
<p>Tutaj jest jedna ciekawostka - Messi strzelający gola z prawego dolnego rogu boiska. Możemy poszukać tej bramki:</p>
<pre class="r"><code>data %&gt;%
  filter(player == &quot;Lionel Messi&quot;, result == &quot;Goal&quot;) %&gt;%
  filter(y_coordinate == min(y_coordinate)) %&gt;%
  t() %&gt;%
  as.data.frame() %&gt;% rownames_to_column() %&gt;% set_names(c(&quot;Feature&quot;, &quot;Value&quot;)) %&gt;%
  kable()  %&gt;%
  kable_styling(bootstrap_options = c(&quot;striped&quot;, &quot;hover&quot;, &quot;condensed&quot;))</code></pre>
<table class="table table-striped table-hover table-condensed" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
Feature
</th>
<th style="text-align:left;">
Value
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
match_id
</td>
<td style="text-align:left;">
3926
</td>
</tr>
<tr>
<td style="text-align:left;">
league
</td>
<td style="text-align:left;">
La_Liga
</td>
</tr>
<tr>
<td style="text-align:left;">
date
</td>
<td style="text-align:left;">
2017-02-04 15:15:00
</td>
</tr>
<tr>
<td style="text-align:left;">
home
</td>
<td style="text-align:left;">
Barcelona
</td>
</tr>
<tr>
<td style="text-align:left;">
away
</td>
<td style="text-align:left;">
Athletic Club
</td>
</tr>
<tr>
<td style="text-align:left;">
home_goals
</td>
<td style="text-align:left;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
away_goals
</td>
<td style="text-align:left;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
team
</td>
<td style="text-align:left;">
Barcelona
</td>
</tr>
<tr>
<td style="text-align:left;">
minute
</td>
<td style="text-align:left;">
39
</td>
</tr>
<tr>
<td style="text-align:left;">
player
</td>
<td style="text-align:left;">
Lionel Messi
</td>
</tr>
<tr>
<td style="text-align:left;">
x_g
</td>
<td style="text-align:left;">
0.05206308
</td>
</tr>
<tr>
<td style="text-align:left;">
shot_type
</td>
<td style="text-align:left;">
LeftFoot
</td>
</tr>
<tr>
<td style="text-align:left;">
result
</td>
<td style="text-align:left;">
Goal
</td>
</tr>
<tr>
<td style="text-align:left;">
x_coordinate
</td>
<td style="text-align:left;">
0.952
</td>
</tr>
<tr>
<td style="text-align:left;">
y_coordinate
</td>
<td style="text-align:left;">
0.116
</td>
</tr>
<tr>
<td style="text-align:left;">
situation
</td>
<td style="text-align:left;">
DirectFreekick
</td>
</tr>
<tr>
<td style="text-align:left;">
assist_player
</td>
<td style="text-align:left;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
preceding_action
</td>
<td style="text-align:left;">
Standard
</td>
</tr>
</tbody>
</table>
<p><a href="https://blog.prokulski.science/l.php?t=gole_w_ligach&amp;u=https://www.google.com/search?q=Barcelona+-+Athletic+Club+2017-02-04">Chwila w Google</a> z wyszukaniem odpowiedniego meczu i mamy <a href="https://blog.prokulski.science/l.php?t=gole_w_ligach&amp;u=https://youtu.be/VRDKncBV7eU?t=230">wynik</a> jak poniżej:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/VRDKncBV7eU?start=230" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<p>A z jakiej odległości padają strzały? Nie będziemy tego przeliczać na metry, a na jednostki względne od środka bramki (punkt (1,0.5) w układzie współrzędnych boiska):</p>
<pre class="r"><code>data %&gt;%
  filter(player %in% top_strikers) %&gt;%
  filter(result == &quot;Goal&quot;) %&gt;%
  mutate(distance = sqrt((x_coordinate-1)^2 + (y_coordinate-0.5)^2)) %&gt;%
  group_by(player) %&gt;%
  mutate(m_dist = mean(distance)) %&gt;%
  ungroup() %&gt;%
  arrange(m_dist) %&gt;%
  mutate(player = fct_inorder(player)) %&gt;%
  ggplot() +
  geom_boxplot(aes(player, distance, fill = player), color = &quot;black&quot;,
               show.legend = FALSE) +
  coord_flip() +
  labs(title = &quot;Z jakiej odległości od bramki padają gole?&quot;,
       x = &quot;&quot;, y  = &quot;Odległośc [skala względna]&quot;) -&gt; plot

da_plot(plot)</code></pre>
<p><img src="blog_post_files/figure-html/gole_07-1.png" width="960" /></p>
<p>Wykres ułożono jest według średniej odległości, a kreska w <em>pudełku</em> mówi o medianie. Wcześniej widzieliśmy, że wszyscy strzelają głównie z pola karnego, zatem nic dziwnego że wyniki są zbliżone.</p>
<p>Poszukajmy najdalszego strzału:</p>
<pre class="r"><code>data %&gt;%
  filter(result == &quot;Goal&quot;) %&gt;%
  mutate(distance = sqrt((x_coordinate-1)^2 + (y_coordinate-0.5)^2)) %&gt;%
  filter(distance == max(distance)) %&gt;%
  t() %&gt;%
  as.data.frame() %&gt;% rownames_to_column() %&gt;% set_names(c(&quot;Feature&quot;, &quot;Value&quot;)) %&gt;%
  kable() %&gt;%
  kable_styling(bootstrap_options = c(&quot;striped&quot;, &quot;hover&quot;, &quot;condensed&quot;))</code></pre>
<table class="table table-striped table-hover table-condensed" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
Feature
</th>
<th style="text-align:left;">
Value
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
match_id
</td>
<td style="text-align:left;">
5424
</td>
</tr>
<tr>
<td style="text-align:left;">
league
</td>
<td style="text-align:left;">
Bundesliga
</td>
</tr>
<tr>
<td style="text-align:left;">
date
</td>
<td style="text-align:left;">
2014-09-20 14:30:00
</td>
</tr>
<tr>
<td style="text-align:left;">
home
</td>
<td style="text-align:left;">
Paderborn
</td>
</tr>
<tr>
<td style="text-align:left;">
away
</td>
<td style="text-align:left;">
Hannover 96
</td>
</tr>
<tr>
<td style="text-align:left;">
home_goals
</td>
<td style="text-align:left;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
away_goals
</td>
<td style="text-align:left;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
team
</td>
<td style="text-align:left;">
Paderborn
</td>
</tr>
<tr>
<td style="text-align:left;">
minute
</td>
<td style="text-align:left;">
92
</td>
</tr>
<tr>
<td style="text-align:left;">
player
</td>
<td style="text-align:left;">
Moritz Stoppelkamp
</td>
</tr>
<tr>
<td style="text-align:left;">
x_g
</td>
<td style="text-align:left;">
0.008978859
</td>
</tr>
<tr>
<td style="text-align:left;">
shot_type
</td>
<td style="text-align:left;">
RightFoot
</td>
</tr>
<tr>
<td style="text-align:left;">
result
</td>
<td style="text-align:left;">
Goal
</td>
</tr>
<tr>
<td style="text-align:left;">
x_coordinate
</td>
<td style="text-align:left;">
0.225
</td>
</tr>
<tr>
<td style="text-align:left;">
y_coordinate
</td>
<td style="text-align:left;">
0.475
</td>
</tr>
<tr>
<td style="text-align:left;">
situation
</td>
<td style="text-align:left;">
OpenPlay
</td>
</tr>
<tr>
<td style="text-align:left;">
assist_player
</td>
<td style="text-align:left;">
Uwe H�nemeier
</td>
</tr>
<tr>
<td style="text-align:left;">
preceding_action
</td>
<td style="text-align:left;">
None
</td>
</tr>
<tr>
<td style="text-align:left;">
distance
</td>
<td style="text-align:left;">
0.7754031
</td>
</tr>
</tbody>
</table>
<p>Znowu chwila z Google i mamy:</p>
<center>
<iframe width="560" height="315" src="https://www.youtube.com/embed/EhMhqz0qvUo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
</center>
<p>Jak wygląda rozkład wyników w poszczególnych ligach? Jaki wynik meczu jest najpopularniejszy? Poniższy wykres to obrazuje:</p>
<pre class="r"><code>data %&gt;%
  select(league, home_goals, away_goals, match_id) %&gt;%
  distinct(match_id, .keep_all = TRUE) %&gt;%
  count(league, away_goals, home_goals, sort = T) %&gt;%
  group_by(league) %&gt;%
  mutate(p = 100*n/sum(n)) %&gt;%
  ungroup() %&gt;%
  ggplot() +
  geom_tile(aes(home_goals, away_goals, fill = p), color = &quot;black&quot;, show.legend = FALSE) +
  geom_text(aes(home_goals, away_goals, label = sprintf(&quot;%.f%%&quot;, p))) +
  scale_x_continuous(breaks = 0:10, limits = c(-1,11)) +
  scale_y_continuous(breaks = 0:10, limits = c(-1,11)) +
  scale_fill_distiller(palette = &quot;Reds&quot;, direction = 1) +
  labs(title = &quot;Rozkład wyników w meczach&quot;,
       x = &quot;Gospodarze&quot;, y = &quot;Goście&quot;) +
  facet_wrap(~league) -&gt; plot

da_plot(plot)</code></pre>
<p><img src="blog_post_files/figure-html/gole_12-1.png" width="1152" /></p>
<p>Najpopularniejsze wyniki to 1:1 albo 1:0 (czy też 0:1). Zdaje się, że rozkład liczby bramek w meczu to rozkład Poissona - to warto wiedzie, jeśli się chce budować jakieś modele przewidujące wyniki.</p>
<p>Przejdźmy na poziom dwóch drużyn. Na początek policzymy sobie dane mówiące o rozkładzie wyników spotkań wszystkich drużyn z każdej ligi pomiędzy sobą:</p>
<pre class="r"><code>data_pairs &lt;- data %&gt;%
  select(home, away, league, home_goals, away_goals, match_id) %&gt;%
  distinct(match_id, .keep_all = TRUE) %&gt;%
  mutate(hG = if_else(home &lt; away, home_goals, away_goals),
         aG = if_else(home &lt; away, away_goals, home_goals),
         h = if_else(home &lt; away, home, away),
         a = if_else(home &lt; away, away, home)) %&gt;%
  count(h, hG, a, aG) %&gt;%
  group_by(h, a) %&gt;%
  mutate(p = 100*n/sum(n)) %&gt;%
  ungroup()</code></pre>
<p>Teraz wybierzemy dwie drużyny i zobaczymy jakie wyniki padły w meczach między nimi:</p>
<pre class="r"><code>A_team = &quot;Manchester City&quot;
B_team = &quot;Liverpool&quot;

data_sel &lt;- data_pairs %&gt;%
  filter(h %in% c(A_team, B_team),
         a %in% c(A_team, B_team))

home_team &lt;- data_sel %&gt;% pull(h) %&gt;% unique()
away_team &lt;- data_sel %&gt;% pull(a) %&gt;% unique()

data_sel %&gt;%
  ggplot() +
  geom_tile(aes(hG, aG, fill = p), color = &quot;black&quot;, show.legend = FALSE) +
  geom_text(aes(hG, aG, label = sprintf(&quot;%.f%%&quot;, p))) +
  scale_x_continuous(breaks = 0:10, limits = c(-1,11)) +
  scale_y_continuous(breaks = 0:10, limits = c(-1,11)) +
  scale_fill_distiller(palette = &quot;Reds&quot;, direction = 1) +
  labs(title = paste(&quot;Rozkład wyników w meczach\n&quot;, home_team, &quot;-&quot;, away_team),
       x = home_team, y = away_team) -&gt; plot

da_plot(plot)</code></pre>
<p><img src="blog_post_files/figure-html/gole_08-1.png" width="960" /></p>
<p>Niestety nie ma bardziej zróżnicowanych danych - Real z Barcą wygląda podobnie (każdy z wyników padł tylko jeden raz, meczy też było 10). Szkoda.</p>
<p>Ale możemy inaczej - ile bramek strzela i ile traci Barcelona w lidze hiszpańskiej?</p>
<pre class="r"><code>sel_team = &quot;Barcelona&quot;

# bilans rozgrywek
data_pairs %&gt;%
  filter(h == sel_team | a == sel_team) %&gt;%
  mutate(sel_goals = if_else(h == sel_team, hG, aG),
         other_goals =  if_else(h == sel_team, aG, hG),
         other =  if_else(h == sel_team, a, h)) %&gt;%
  select(other, sel_goals, other_goals, n) %&gt;%
  gather(&quot;key&quot;, &quot;val&quot;, -other, -n) %&gt;%
  mutate(key = factor(key, levels = c(&quot;sel_goals&quot;, &quot;other_goals&quot;),
                      labels = c(&quot;Bramki strzelone&quot;, &quot;Bramki stracone&quot;))) %&gt;%
  ggplot() +
  geom_tile(aes(other, val, fill = n), color = &quot;black&quot;) +
  scale_y_continuous(breaks = 0:10) +
  scale_fill_distiller(palette = &quot;Reds&quot;, direction = 1) +
  facet_wrap(~key, ncol = 2) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust = 1)) +
  labs(title = paste0(&quot;Liczba strzelonych/straconych bramek: &quot;, sel_team),
       x = &quot;Przeciwnik&quot;, y = &quot;&quot;, fill = &quot;Liczba bramek&quot;) -&gt; plot

da_plot(plot, legend_bottom = T)</code></pre>
<p><img src="blog_post_files/figure-html/gole_09-1.png" width="960" /></p>
<p>Oczywiście zamiast Barcelony możemy wybrać inny zespół.</p>
<p>A jak wygląda bilans bramek Barcy? Ile średnio goli strzela i ile traci w meczach ze swoimi rywalami z La Liga?</p>
<pre class="r"><code>data_pairs %&gt;%
  filter(h == sel_team | a == sel_team) %&gt;%
  mutate(sel_goals = if_else(h == sel_team, hG, aG),
         other_goals =  if_else(h == sel_team, aG, hG),
         other =  if_else(h == sel_team, a, h)) %&gt;%
  select(other, sel_goals, other_goals, n) %&gt;%
  mutate(sel_goals = n * sel_goals,
         other_goals = n * other_goals) %&gt;%
  group_by(other) %&gt;%
  summarise(sel_goals = sum(sel_goals)/n(),
            other_goals = sum(other_goals)/n()) %&gt;%
  ungroup() %&gt;%
  mutate(delta = sel_goals - other_goals) %&gt;%
  arrange(desc(delta)) %&gt;%
  mutate(other = fct_inorder(other) %&gt;% fct_rev()) %&gt;%
  ggplot() +
  geom_col(aes(other, sel_goals), fill = &quot;green&quot;) +
  geom_text(aes(other, sel_goals, label = sprintf(&quot;%.2f&quot;, sel_goals)), hjust = -0.1) +
  geom_col(aes(other, -other_goals), fill = &quot;red&quot;) +
  geom_text(aes(other, -other_goals, label = sprintf(&quot;%.2f&quot;, other_goals)), hjust = 1.01) +
  geom_point(aes(other, delta), color = &quot;black&quot;, size = 2) +
  # geom_text(aes(other, delta, label = sprintf(&quot;%.2f&quot;, delta)), hjust = -0.2) +
  coord_flip() +
  labs(title = paste0(&quot;Średnia liczba bramek strzelonych/straconych: &quot;, sel_team),
       subtitle = &quot;Zielony = bramki strzelone\nCzerwony = bramki stracone&quot;,
       x = &quot;Przeciwnik&quot;, y = &quot;&quot;) -&gt; plot

da_plot(plot)</code></pre>
<p><img src="blog_post_files/figure-html/gole_10-1.png" width="960" /></p>
<p>Czarna kropka to różnica średnich - jak widać FC Barcelona z każdym rywalem jest <em>na plusie</em>.</p>
<p>Wróćmy do naszych top 12 zawodników. Kto im asystuje? Możemy narysować to na grafie:</p>
<pre class="r"><code>passes_graph &lt;- data %&gt;%
  filter(result == &quot;Goal&quot;) %&gt;%
  filter(player %in% top_strikers) %&gt;%
  filter(!is.na(assist_player)) %&gt;%
  count(assist_player, player) %&gt;%
  select(from = assist_player, to = player, weight = n) %&gt;%
  graph_from_data_frame(directed = TRUE)


plot(passes_graph,
     vertex.color = if_else(V(passes_graph)$name %in% top_strikers, &quot;blue&quot;, &quot;lightblue&quot;),
     vertex.size = if_else(V(passes_graph)$name %in% top_strikers, 7, 3),
     vertex.label.cex = 1,
     vertex.label.color =  if_else(V(passes_graph)$name %in% top_strikers, &quot;gray80&quot;, &quot;gray20&quot;),
     edge.arrow.size = 0,
     edge.arrow.width = E(passes_graph)$weight,
     edge.width = E(passes_graph)$weight,
     edge.curved = TRUE)</code></pre>
<p><img src="blog_post_files/figure-html/gole_11-1.png" width="1536" /></p>
<p>Nie widać tego dobrze na powyższym obrazku, ale w odpowiednim powiększeniu (kliknij na obrazek) widać na przykład pana Lucasa Mourę - jest pomiędzy dwoma różnymi grupami. Dlaczego? Ano, bo przeszedł z PSG do Tottenham i podaje już komuś innemu :)</p>
<p>Przy użyciu pakietu networkD3 możemy przygotować z gotowego grafu (obiektu pakietu igraph) interaktywną wersję:</p>
<pre class="r"><code>library(networkD3)

passes_graph_d3 &lt;- igraph_to_networkD3(passes_graph)

forceNetwork(Links = passes_graph_d3$links, Nodes = passes_graph_d3$nodes,
             Source = &#39;source&#39;, Target = &#39;target&#39;,
             NodeID = &#39;name&#39;, Group = &#39;name&#39;,
             linkWidth = passes_graph_d3$links$value,
             fontSize = 11,
             opacityNoHover = 0.6,
             zoom = TRUE)</code></pre>
<center>
<iframe src="player_d3.html" width="700" height="600" frameborder="0">
</iframe>
</center>
<p>Prawda, że fajne?</p>
<p>To początek prac, jakieś pomysły po pół dnia przyglądania się danym. Jeśli masz ochotę - możesz użyć przygotowanego wyżej kodu do zbudowania na przykład aplikacji w Shiny, w której będzie można wybrać drużyny albo zawodników i dla każdego takiego wyboru wygenerować odpowiednie wykresiki. A gdyby jeszcze zasilać dane (trzeba by scrapper napisać) każdego dnia byłoby prawie online. Dlaczego <a href="https://blog.prokulski.science/l.php?t=gole_w_ligach&amp;u=https://understat.com/">understat.com</a> tego nie ma?</p>
<p>Miło będzie jeśli docenisz trud autora <strong><a href="https://blog.prokulski.science/l.php?t=gole_w_ligach&amp;u=https://www.paypal.me/prokulski/10pln">stawiając dużą kawę</a></strong>. Wpadnij też na <strong><a href="https://blog.prokulski.science/l.php?t=gole_w_ligach&amp;u=http://facebook.com/DaneAnalizy/">Dane i Analizy na Facebooku</a></strong> – tam więcej takich smaczków (szczególnie dla praktyków).</p>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
